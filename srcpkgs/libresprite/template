# Template file for 'libresprite'
pkgname=libresprite
version=1.0
revision=1
create_wrksrc=yes
build_style=cmake
configure_args="-DWITH_DESKTOP_INTEGRATION=ON"
hostmakedepends="tinyxml-devel"
makedepends="zlib-devel libpng-devel freetype-devel giflib-devel gtest-devel libjpeg-turbo-devel libcurl-devel SDL2-devel SDL2_image-devel lua-devel pixman-devel tinyxml-devel"
checkdepends="xvfb-run"
short_desc="Animated sprite editor & pixel art tool"
maintainer="Mohammad Ebrahimi <moh.ebrahimi2000@gmail.com>"
license="GPL-2.0-or-later"
homepage="https://libresprite.github.io"
_clip_commit=a65a9e543e9a270bb7c58789d15d027bbd8efb2a
_flic_commit=65a6072fa0aa611c383b44d21b87d41e2ea8b523
_observable_commit=89c97405025c17fbce5b147aae86fe35b00f98e5
_undo_commit=f39b188e29d0f9adaa49c8705c0f492939d967a9
_duktape_commit=6f715553e706b61e611aa4ae8e6fe90626800dae
_simpleini_commit=0687587cef1816a04307d632e517be9803bbdca6
distfiles="
 https://github.com/LibreSprite/LibreSprite/archive/refs/tags/v${version}.tar.gz
 https://github.com/aseprite/clip/archive/${_clip_commit}.tar.gz
 https://github.com/aseprite/flic/archive/${_flic_commit}.tar.gz
 https://github.com/dacap/observable/archive/${_observable_commit}.tar.gz
 https://github.com/aseprite/undo/archive/${_undo_commit}.tar.gz
 https://github.com/LibreSprite/duktape/archive/${_duktape_commit}.tar.gz
 https://github.com/aseprite/simpleini/archive/${_simpleini_commit}.tar.gz"
checksum="7f1fc58ba3c1c7dae384a2e893d0b9d821c6213a5121f263d0964deabd07708e
 f08780c5c49cbeb560967016e0c653d68c673a8101f7a175b79cbf0f19ec1fae
 5bf8341c01ddbd872aadd372827d2bbd191455abde9693aca867e23075c1286a
 e26e26e3068a4f0f79b1c3f76dc5a5c825a2f7748db4d38594453e7fdf4cb82a
 8881e3d4c7d9d29c91640649ad8d292be5646fa3fd26be6b49bba1d00e38acba
 711a5cb7e3d663d7673d635a11a3b38fe67cf63b1c9f7eb406ebd107a25b7004
 0c00c28a2d85ca9f7cee2462988643b1b6b9c34b692f4f8740c93c988c1e446d"
make_check_pre="xvfb-run"

if [[ "$XBPS_TARGET_MACHINE" != "armv"[67]* ]]
then
	makedepends+=" nodejs-devel"
fi

post_extract() {
	mv ${wrksrc}/LibreSprite-${version}/* ${wrksrc}
	rmdir -v ${wrksrc}/src/clip
	mv ${wrksrc}/clip-${_clip_commit} ${wrksrc}/src/clip
	rmdir -v ${wrksrc}/src/flic
	mv ${wrksrc}/flic-${_flic_commit} ${wrksrc}/src/flic
	rmdir -v ${wrksrc}/src/observable
	mv ${wrksrc}/observable-${_observable_commit} ${wrksrc}/src/observable
	rmdir -v ${wrksrc}/src/undo
	mv ${wrksrc}/undo-${_undo_commit} ${wrksrc}/src/undo
	rmdir -v ${wrksrc}/third_party/duktape
	mv ${wrksrc}/duktape-${_duktape_commit} ${wrksrc}/third_party/duktape
	rmdir -v ${wrksrc}/third_party/simpleini
	mv ${wrksrc}/simpleini-${_simpleini_commit} ${wrksrc}/third_party/simpleini

	if [[ "$CROSS_BUILD" ]]
	then
		mv ${wrksrc}/CMakeLists.txt ${wrksrc}/CMakeLists.txt.old
		cp ${FILESDIR}/CMakeLists.txt ${wrksrc}/CMakeLists.txt
		mv ${wrksrc}/src/CMakeLists.txt ${wrksrc}/src/CMakeLists.txt.old
		cp ${FILESDIR}/src/CMakeLists.txt ${wrksrc}/src/CMakeLists.txt
		mv ${wrksrc}/third_party/CMakeLists.txt ${wrksrc}/third_party/CMakeLists.txt.old
		cp ${FILESDIR}/third_party/CMakeLists.txt ${wrksrc}/third_party/CMakeLists.txt

		mkdir -p ${wrksrc}/build/${XBPS_MACHINE}
		cd ${wrksrc}/build/${XBPS_MACHINE}
		cmake -G Ninja ../..
		ninja

		sed -i "s/bin\/gen/${XBPS_MACHINE}\/bin\/gen/g" ${wrksrc}/src/app/CMakeLists.txt
		sed -r "s/DEPENDS gen//g" ${wrksrc}/src/app/CMakeLists.txt
		
		rm ${wrksrc}/CMakeLists.txt
		mv ${wrksrc}/CMakeLists.txt.old ${wrksrc}/CMakeLists.txt
		rm ${wrksrc}/src/CMakeLists.txt
		mv ${wrksrc}/src/CMakeLists.txt.old ${wrksrc}/src/CMakeLists.txt
		rm ${wrksrc}/third_party/CMakeLists.txt
		mv ${wrksrc}/third_party/CMakeLists.txt.old ${wrksrc}/third_party/CMakeLists.txt

		sed -r "s/add_subdirectory(gen)//g" ${wrksrc}/src/CMakeLists.txt
	fi
}

post_install() {
	vdoc ${wrksrc}/docs/files/ase.txt
	vdoc ${wrksrc}/docs/files/fli.txt
	vdoc ${wrksrc}/docs/files/msk.txt
	vdoc ${wrksrc}/docs/files/pic.txt
	vdoc ${wrksrc}/docs/files/picpro.txt
}
